"use strict";Number.isFinite=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)};var ENABLE_VIGO_SDK_LOG,VigoStats=function(){function e(e,i){var o=this;this.isCollecting=!0,this.callbacks={},this.logPrefix="%c[VIGOSTATS]: ",this.logGreen="color:green",this.logCyan="color:cyan",this.VigoIdKey="v_did",this.VigoDeviceIdUrl="https://api.vigo.tech/html5/cgi-bin/vigoUrandId.php",this.notifyUrl="https://api.vigo.tech/uxzoom/1/notify",this.cdnConfigUrl="https://cdn.vigo.tech/1/balancer",this.cdnConfigResponse=null,this.inputCheckRegex=new RegExp("^[^,=]*$"),this.events={play:"play",pause:"pause",resume:"resume",stop:"stop",seek:"seek",bufStart:"buf_start",bufStop:"buf_stop",heartbeat:"heartbeat",bitrateChange:"bitrate_change",error:"error"},this.vMerr=["","The fetching of the associated resource has been aborted by the user","A network error caused the resource to stop being fetched.","A decoding error caused the resource to stop being fetched.","The associated resource has been detected to be not suitable"],this.V_PAUSED_HB_TIMEOUT=12e4,this.V_UNPAUSED_HB_TIMEOUT=3e4,this.V_EVENT_DROP_TIMEOUT=3e5,this.V_MAX_REQUEST_LENGTH=30,this.requests={},this.lastReqId=void 0,this.flushedSeqnums={},this.seq=0,this.bufNum=0,this.isBegan=!1,this.isWaiting=!1,this.isPaused=!1,this.isEnded=!1,this.heartbeatPeriod=this.V_UNPAUSED_HB_TIMEOUT,this.requestCdnConfig=function(){var e=new XMLHttpRequest;e.open("GET",o.cdnConfigUrl+"?svcid="+o.info.svcid,!0),e.onload=function(){try{try{o.cdnConfigResponse=JSON.parse(e.responseText)}catch(e){console.error("Bad response from "+o.cdnConfigUrl),o.cdnConfigResponse=null}setTimeout(o.requestCdnConfig,(o.cdnConfigResponse?o.cdnConfigResponse.timeout:0)||6e4)}catch(e){console.error(e)}},e.onerror=function(e){console.error(e),setTimeout(o.requestCdnConfig,(o.cdnConfigResponse?o.cdnConfigResponse.timeout:0)||6e4)},e.send()},this.getCDN=function(){if(o.cdnConfigResponse&&o.cdnConfigResponse.cdn)return(o.cdnConfigResponse.cdn.find(function(e){return e[o.info.svcid]})||{})[o.info.svcid]};try{var t,n,s=this,r=(this.media=e,this.info={svcid:i.svcid,cid:i.cid,wid:i.wid,quality:i.quality,host:i.host,player:i.player,getBytes:i.getBytes,getBitrate:i.getBitrate,contentId:i.contentId,deviceId:i.deviceId,customMap:Object.keys("object"==typeof i.customMap?i.customMap:{}).reduce(function(e,t){return 10<=Object.keys(e).length||(t.match(o.inputCheckRegex)&&i.customMap[t].match(o.inputCheckRegex)?e[t]=i.customMap[t]:console.info("Bad symbols in custom map key "+t)),e},{}),appVersion:i.appVersion,isLiveStream:i.isLiveStream,model:i.model,type:i.type,os:i.os},this.content={host:this.info.host,quality:this.info.quality,duration:null},this.getCookie(this.VigoIdKey)),a=this.getLs(this.VigoIdKey),l=r||a;this.client={player:this.info.player,id:l||null,did:i.deviceId,appversion:i.appVersion,model:i.model,type:i.type,os:i.os},l?r!==a&&(this.setCookie(this.VigoIdKey,l),this.setLs(this.VigoIdKey,l)):(t=function(e){e=e.message||e.data;"string"==typeof e&&0===e.indexOf("vigo_device_id=")&&47===e.length?(e=e.replace("vigo_device_id=",""),o.setCookie(o.VigoIdKey,e),o.setLs(o.VigoIdKey,e),s.client.id=e):void 0!==ENABLE_VIGO_SDK_LOG&&console.log(s.logPrefix,"color:orange","wrong id returned",e)},window.addEventListener?window.addEventListener("message",t):window.attachEvent("onmessage",t),(n=document.createElement("iframe")).src=this.VigoDeviceIdUrl,n.style.display="none",document.body.appendChild(n)),this.requests={},this.lastReqId=void 0,this.seq=0,this.bufNum=0,this.isBegan=!1,this.isWaiting=!1,this.isPaused=!1,this.isCollecting=!0,this.isEnded=!1,this.heartbeatPeriod=this.V_UNPAUSED_HB_TIMEOUT,this.callbacks={},void 0!==window.performance&&void 0!==window.performance.now?this.timeOffsetFn=function(){return Math.round(window.performance.now())}:this.timeOffsetFn=function(){return null},this.requestCdnConfig()}catch(e){console.error(e),console.info("Can not initialize vigo SDK")}}return e.prototype.storeEvent=function(e,t){var i=void 0!==(t=void 0===t?{}:t).position?t.position:null,o=void 0!==t.bufNum?t.bufNum:null,n=void 0!==t.bufTime?t.bufTime:null,t=void 0!==t.error?t.error:null,e=(this.isBegan||this.callbacks.play0(),Number.isFinite(this.content.duration)&&this.updateDuration(),{type:e,seq:++this.seq,ts:Date.now(),t:this.timeOffsetFn(),tz:-60*(new Date).getTimezoneOffset(),pos:Number.isFinite(i)?i:this.media.currentTime,buffer:this.getBufferPercent(this.media),bytes:this.info.getBytes(),bitrate:this.info.getBitrate(),buf_num:o,buf_time:n,load_state:this.isWaiting?"buffering":null,err:t});void 0===this.lastReqId||this.requests[this.lastReqId].ev.length>=this.V_MAX_REQUEST_LENGTH?this.createRequest([e]):this.requests[this.lastReqId].ev.push(e)},e.prototype.startPlayback=function(){this.play(),4!==this.media.readyState&&3!==this.media.readyState&&this.bufStart(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(this.logPrefix,this.logGreen,"start playback")},e.prototype.endPlayback=function(){this.stop(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(this.logPrefix,this.logGreen,"end playback")},e.prototype.updateHost=function(e){this.content.host=e,this.createRequest(),this.heartbeat(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(this.logPrefix,this.logGreen,"update host = "+e)},e.prototype.updateQuality=function(e){this.content.quality=e,this.createRequest(),this.heartbeat(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(this.logPrefix,this.logGreen,"update quality = "+e)},e.prototype.play=function(){var e=this;this.isEnded||this.isBegan||(this.isBegan=!0,this.storeEvent(e.events.play),this.flushRequests(),this.heartbeatTimer=setTimeout(function(){e.heartbeat.call(e)},this.heartbeatPeriod))},e.prototype.pause=function(){var e=this;this.isEnded||this.isPaused||(this.storeEvent(e.events.pause),this.flushRequests(),this.isPaused=!0,void 0!==this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.heartbeatPeriod=this.V_PAUSED_HB_TIMEOUT,this.heartbeatTimer=setTimeout(function(){e.heartbeat.call(e)},this.heartbeatPeriod))},e.prototype.resume=function(){var e=this;!this.isEnded&&this.isPaused&&(this.storeEvent(e.events.resume),this.flushRequests(),this.isPaused=!1,void 0!==this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.heartbeatPeriod=this.V_UNPAUSED_HB_TIMEOUT,this.heartbeatTimer=setTimeout(function(){e.heartbeat.call(e)},this.heartbeatPeriod))},e.prototype.stop=function(){var i=this;!this.isEnded&&this.isBegan&&(this.storeEvent(i.events.stop),this.flushRequests(),this.isEnded=!0,void 0!==this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.forEachElement(this.callbacks,function(e,t){i.media.removeEventListener(e,t)}))},e.prototype.seek=function(){var e=this;this.isEnded||this.info.isLiveStream||(this.storeEvent(e.events.seek),this.flushRequests(),void 0!==this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.heartbeatTimer=setTimeout(function(){e.heartbeat.call(e)},this.heartbeatPeriod))},e.prototype.bufStart=function(){var e=this;this.isEnded||this.isWaiting||(this.isWaiting=!0,this.bufStartedAt=null===this.timeOffsetFn()?Date.now():this.timeOffsetFn(),this.storeEvent(e.events.bufStart,{bufNum:++this.bufNum}),this.flushRequests(),void 0!==this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.heartbeatTimer=setTimeout(function(){e.heartbeat.call(e)},this.heartbeatPeriod))},e.prototype.bufStop=function(){var e=this;!this.isEnded&&this.isWaiting&&(this.isWaiting=!1,this.storeEvent(e.events.bufStop,{bufNum:this.bufNum,bufTime:(null===this.timeOffsetFn()?Date.now():this.timeOffsetFn())-this.bufStartedAt}),this.flushRequests(),void 0!==this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.heartbeatTimer=setTimeout(function(){e.heartbeat.call(e)},this.heartbeatPeriod))},e.prototype.heartbeat=function(){var e=this;this.storeEvent(e.events.heartbeat),this.flushRequests(),void 0!==this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.heartbeatTimer=setTimeout(function(){e.heartbeat.call(e)},this.heartbeatPeriod)},e.prototype.bitrateChange=function(e){var t=this;this.isEnded||(e=isNaN(e)?null:Number(e),this.isBegan?(this.content.quality===e?this.storeEvent(t.events.heartbeat):(this.content.quality=e,this.createRequest(),this.storeEvent(t.events.bitrateChange)),this.flushRequests(),void 0!==this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.heartbeatTimer=setTimeout(function(){t.heartbeat.call(t)},this.heartbeatPeriod),4!==this.media.readyState&&3!==this.media.readyState&&this.bufStart()):this.content.quality=e)},e.prototype.error=function(e){var t=this;this.storeEvent(t.events.error,{error:null!==(e=void 0===e?null:e)?e:null!=this.media.error?t.vMerr[this.media.error.code]:null}),this.flushRequests(),void 0!==this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.heartbeatTimer=setTimeout(function(){t.heartbeat.call(t)},this.heartbeatPeriod)},e.prototype.createRequest=function(e){e={co:{quality:this.content.quality,duration:this.content.duration,host:this.content.host,id:this.info.contentId},wid:this.info.wid,ev:e=void 0===e?[]:e};void 0===this.lastReqId?this.lastReqId=0:this.lastReqId++,this.requests[this.lastReqId]=e},e.prototype.flushRequests=function(){var a=this,l=this;this.forEachElement(this.requests,function(e,i){for(var t=null===l.timeOffsetFn()?Date.now():l.timeOffsetFn(),o=0;o<i.ev.length;o++)t-(Number.isFinite(i.ev[o].t)?i.ev[o].ts:i.ev[o].t)>a.V_EVENT_DROP_TIMEOUT&&(delete l.flushedSeqnums[i.ev[o].seq],i.ev[o]=i.ev[i.ev.length-1],i.ev.length--,o--);var n,s,r={onload:function(e){for(var t=0;t<i.ev.length;t++)l.flushedSeqnums[i.ev[t].seq]&&(delete l.flushedSeqnums[i.ev[t].seq],i.ev[t]=i.ev[i.ev.length-1],i.ev.length--,t--);void 0!==ENABLE_VIGO_SDK_LOG&&console.log(l.logPrefix,l.logGreen,"HTTP request state change: status = "+e.status+"; readyState = "+e.readyState)},onerror:function(e,t){void 0!==ENABLE_VIGO_SDK_LOG&&(console.error("[VIGOSTATS]: ","HTTP request error: status = "+e.status+"; readyState = "+e.readyState),console.log(t))}};0<i.ev.length?(n=[],a.forEachElement(i.ev,function(e,t){l.flushedSeqnums[t.seq]||(l.flushedSeqnums[i.ev[e].seq]=!0,n.push(a.paramString(t)))}),n.length&&(s=a.queryString({svcid:l.info.svcid,cid:l.info.cid,wid:i.wid,client:a.paramString(l.client),co:a.paramString(i.co),cm:l.info.customMap?a.paramString(l.info.customMap):void 0,ev:n}),a.sendGetRequest(a.notifyUrl+"?"+s,r))):(e===l.lastReqId&&a.createRequest(),delete l.requests[e])})},e.prototype.onWindowClose=function(){return this.stop(),null},e.prototype.updateDuration=function(){var e=+(null==(e=null==(e=this.media)?void 0:e.duration)?void 0:e.toFixed(3));this.content.duration=isNaN(e)?null:e,this.createRequest()},e.prototype.suspendCollecting=function(){void 0!==ENABLE_VIGO_SDK_LOG&&console.log(this.logPrefix,this.logCyan,"suspendCollecting")},e.prototype.resumeCollecting=function(){void 0!==ENABLE_VIGO_SDK_LOG&&console.log(this.logPrefix,this.logCyan,"resumeCollecting")},e.prototype.suspendStats=function(){this.isCollecting=!1,this.pause(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(this.logPrefix,this.logCyan,"suspendStats")},e.prototype.resumeStats=function(){this.isCollecting=!0,this.updateDuration(),this.resume(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(this.logPrefix,this.logCyan,"resumeStats")},e.prototype.getBufferPercent=function(e){for(var t=0,i=e.buffered,o=e.currentTime;i.length>t&&!(i.start(t)<=o&&o<=i.end(t));)t+=1;return i.length<=t?null:100*i.end(t)/e.duration},e.prototype.sendGetRequest=function(e,t){var i=t&&t.onload||null,o=t&&t.onerror||null,n=new XMLHttpRequest;n.open("GET",e,!0),n.onload=function(){return i(n)},n.onerror=function(e){return o(n,e)},n.send()},e.prototype.paramString=function(e){var i=[];return this.forEachElement(e,function(e,t){null!=t&&i.push(e+"="+t)}),i.join(",")},e.prototype.queryString=function(e){var t=this,o=[];return this.forEachElement(e,function(i,e){Array.isArray(e)||(e=[e]),t.forEachElement(e,function(e,t){t&&o.push(encodeURIComponent(i)+"="+encodeURIComponent(t))})}),o.join("&")},e.prototype.forEachElement=function(t,i){Object.keys(t).forEach(function(e){i(e,t[e])})},e.prototype.supportsHTML5Storage=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},e.prototype.setCookie=function(e,t){document.cookie=e+"="+t},e.prototype.getCookie=function(e){for(var t=e+"=",i=0,o=document.cookie.split(";");i<o.length;i++){for(var n=o[i],s=0;" "===n.charAt(s);)s++;if(0===(n=n.substring(s,n.length)).indexOf(t))return n.substring(t.length,n.length)}},e.prototype.setLs=function(e,t){this.supportsHTML5Storage()&&window.localStorage.setItem(e,t)},e.prototype.getLs=function(e){if(this.supportsHTML5Storage())return window.localStorage.getItem(e)},e}();function initVigo(e,t){var i=new VigoStats(e,t);return e.addEventListener("durationchange",i.callbacks.durationchange=function(){i.isCollecting&&i.updateDuration(),void 0!==ENABLE_VIGO_SDK_LOG&&(console.log(i.logPrefix,i.logGreen,"durationchange"),console.log(i.logPrefix,i.logGreen,"vigo.duration = ",i.content.duration,"media.duration = ",i.media.duration))}),e.addEventListener("play",i.callbacks.play0=function(){i.isCollecting&&i.updateDuration(),i.startPlayback(),i.media.removeEventListener("play",i.callbacks.play0),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"play0")}),e.addEventListener("canplay",i.callbacks.canplay=function(){i.isCollecting&&i.bufStop(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"canplay")}),e.addEventListener("pause",i.callbacks.pause=function(){i.isCollecting&&i.pause(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"pause")}),e.addEventListener("play",i.callbacks.play=function(){i.isCollecting&&i.resume(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"play")}),e.addEventListener("seeking",i.callbacks.seeking=function(){i.isCollecting&&i.seek(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"seeking")}),e.addEventListener("waiting",i.callbacks.waiting=function(){i.isCollecting&&i.bufStart(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"waiting")}),e.addEventListener("seeked",i.callbacks.seeked=function(){i.isCollecting&&i.bufStop(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"seeked")}),e.addEventListener("playing",i.callbacks.playing=function(){i.isCollecting&&i.bufStop(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"playing")}),e.addEventListener("ended",i.callbacks.ended=function(){i.isCollecting&&i.stop(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"ended")}),e.addEventListener("error",i.callbacks.error=function(){i.isCollecting&&i.error(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"error")}),e.addEventListener("abort",i.callbacks.abort=function(){i.isCollecting&&i.stop(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"abort")}),e.addEventListener("emptied",i.callbacks.emptied=function(){void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"emptied")}),e.addEventListener("encrypted",i.callbacks.encrypted=function(){void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"encrypted")}),e.addEventListener("interruptbegin",i.callbacks.interruptbegin=function(){void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"interruptbegin")}),e.addEventListener("interruptend",i.callbacks.interruptend=function(){void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"interruptend")}),e.addEventListener("loadeddata",i.callbacks.loadeddata=function(){void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"loadeddata")}),e.addEventListener("loadedmetadata",i.callbacks.loadedmetadata=function(){void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"loadedmetadata")}),e.addEventListener("loadstart",i.callbacks.loadstart=function(){void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"loadstart")}),e.addEventListener("mozaudioavailable",i.callbacks.mozaudioavailable=function(){void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"mozaudioavailable")}),e.addEventListener("ratechange",i.callbacks.ratechange=function(){i.heartbeat(),void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"ratechange")}),e.addEventListener("stalled",i.callbacks.stalled=function(){void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"stalled")}),e.addEventListener("suspend",i.callbacks.suspend=function(){void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"suspend")}),e.addEventListener("volumechange",i.callbacks.volumechange=function(){void 0!==ENABLE_VIGO_SDK_LOG&&console.log(i.logPrefix,i.logGreen,"volumechange")}),window.addEventListener("beforeunload",function(){i.onWindowClose()}),i}window.V_VIGO_SCRIPT_LOADED=!0;
//# sourceMappingURL=Vigo.min.js.map